# Magai-WiFi 模块

## 概述

Magai-WiFi 是一个基于 ESP32 的智能设备模块，集成了WiFi连接、天气显示、触摸控制和LED灯效等功能。该模块主要用于提供智能语音助手界面，并在空闲状态下自动切换为天气时钟显示模式。

## 硬件规格

- **主控芯片**：ESP32系列
- **显示屏**：NV303b LCD显示屏 (240x280分辨率)
- **按键**：
  - 触摸按钮 (GPIO 0)
  - 音量增加按钮 (GPIO 1)
  - 音量减小按钮 (GPIO 43)
- **LED**：内置12个LED灯 (GPIO 2)
- **音频接口**：I2S接口
  - 麦克风：GPIO 4(WS), 5(SCK), 6(DIN)
  - 扬声器：GPIO 7(DOUT), 15(BCLK), 16(LRCK)
- **显示屏接口**：
  - 8位并行数据线 (GPIO 14, 21, 47, 48, 45, 38, 39, 40)
  - 控制信号线：GPIO 8(PCLK), 13(DC)
  - 背光控制：GPIO 44
- **I2C接口**：GPIO 18(SDA), 17(SCL)

## 软件功能

### 1. 天气时钟功能

- **自动城市检测**：通过公网IP自动获取当前城市
- **中文城市名显示**：从心知天气API返回的数据中提取中文城市名进行显示
- **天气数据获取**：使用心知天气API获取实时天气信息
- **定时更新**：每60分钟自动更新一次天气数据
- **空闲模式切换**：设备在空闲状态时自动切换到天气时钟显示模式
- **智能天气图标显示**：
  - 使用内存映射文件系统加载PNG格式天气图标
- 支持天气代码自动映射（如代码9映射到154.png阴天图标）
  - 图标大小自适应（32x32像素）
  - 加载失败时自动使用默认晴天图标
  - 支持实时天气代码更新和图标切换

### 2. 语音交互功能

- **触摸控制**：按下触摸按钮开始语音监听，松开停止
- **音量控制**：通过音量按钮调节设备音量
  - 短按：增加/减少10%音量
  - 长按：设置为最大/最小音量

### 3. IoT功能

- **设备管理**：集成了Speaker、Lamp、Screen等虚拟设备
- **状态监控**：监控设备状态变化并触发相应动作

## 代码结构

### 主要类

1. **NV303bDisplay**：显示屏控制类
   - 继承自SpiLcdDisplay
   - 实现天气时钟UI的创建和更新
   - 管理UI元素的显示和隐藏

2. **magai_wifi**：主板类
   - 继承自WifiBoard
   - 初始化各硬件组件
   - 管理设备状态和模式切换
   - 包含MagaiLed内部类，用于处理LED状态变化

3. **Weather**：天气服务类
   - 继承自Thing
   - 提供天气数据获取和更新功能
   - 支持自动城市检测和定时更新
   - 从API响应中提取并显示中文城市名

4. **WeatherDisplayNew**：天气图标显示模块
   - 管理天气图标的创建、加载和显示
   - 实现天气代码到图标文件的智能映射
   - 使用内存映射文件系统优化图标加载性能
   - 提供图标可见性和位置管理功能

### 主要文件

- **magai_wifi.cc**：主要实现文件，包含NV303bDisplay和magai_wifi类的实现
- **weather.h/cc**：天气服务相关功能实现
- **weather_display_new.h/c**：新版天气图标显示模块实现
- **config.h**：硬件配置和引脚定义
- **weather目录**：天气图标PNG文件存储目录

## 使用方法

### 初始化流程

1. 创建magai_wifi实例时会自动执行以下初始化：
   - 初始化按钮和回调函数
   - 初始化IoT设备和天气服务
   - 初始化I2C总线
   - 初始化NV303b显示屏
   - 恢复背光亮度
   - 检查初始设备状态并更新UI

### 天气时钟模式

- 设备在空闲状态时自动切换到天气时钟模式
- 显示当前城市、时间、温度和天气状况
- 设备退出空闲状态时自动切换回正常UI

### 状态变化处理

- 通过MagaiLed类的OnStateChanged方法监控设备状态变化
- 在状态变为空闲时自动触发天气数据更新
- 更新天气时钟UI显示

## 维护注意事项

1. **天气API**：如需更换天气API，需修改weather.cc中的相关URL和解析逻辑
2. **城市检测**：城市检测依赖于公网IP服务，如服务不可用需提供备选方案
3. **中文城市名**：中文城市名从心知天气API的location.name字段获取，如API返回格式变化需相应调整解析代码
4. **UI定制**：天气时钟UI的布局和样式可在NV303bDisplay::SetupWeatherClockUI方法中修改
5. **定时更新**：天气数据更新频率可在Weather类的StartPeriodicUpdate方法中调整
6. **内存管理**：注意在析构函数中释放动态分配的资源，避免内存泄漏
7. **天气图标管理**：
   - 天气图标文件存储在内存映射分区中，格式为PNG
   - 天气代码映射逻辑在weather_display_new.c的weather_icon_new_update函数中
   - 如需添加新的天气图标，直接将PNG文件放入weather目录即可
   - 图标大小和位置可在weather_display_new.c和magai_wifi.cc中调整

## 故障排除

- **天气数据获取失败**：检查WiFi连接状态和API服务可用性
- **城市名显示异常**：检查心知天气API返回的JSON数据格式，确认location.name字段是否存在
- **天气图标不显示**：
  - 检查内存映射文件系统是否正确初始化
  - 确认天气代码映射是否正确（查看日志中的映射信息）
  - 检查图标文件是否存在于内存映射分区中
  - 验证图标对象的可见性标志是否正确设置
- **显示异常**：检查显示屏初始化参数和引脚配置
- **按钮无响应**：检查按钮引脚配置和回调函数注册
- **LED不工作**：检查LED引脚配置和数量设置
- **编译错误**：注意printf格式化字符串与参数类型匹配，使用适当的类型转换

## 未来改进

1. 添加更多天气数据显示（如湿度、风速等）
2. 优化天气图标和UI布局
3. 增加用户自定义城市设置功能
4. 添加多语言支持
5. 优化网络连接和数据获取的稳定性
6. 增强城市名称本地化显示，支持更多地区的本地语言