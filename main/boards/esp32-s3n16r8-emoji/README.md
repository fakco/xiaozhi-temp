# ESP32-S3N16R8-Emoji 

## 硬件要求

- ESP32 S3 N16R8开发板
- INMP441 MEMS麦克风
- Max98357A I2S音频放大器
- SSD1306 OLED显示屏 (128x64)
- 2个SG90舵机 (水平和垂直)
- 扬声器
- 面包板和连接线

## 功能特性

### 1. 对话功能
- 支持语音对话
- 支持文字显示
- 支持音量调节
  - 支持按键调节：音量+/音量-按钮
  - 支持语音调节：如"音量设为50"、"音量调到80"等命令
  - 支持多种音量控制命令格式：
    - "音量设为xx"
    - "音量调到xx"
    - "把音量设为xx"
    - "将声音设置为xx"
    - "音量增加"/"音量加大"
    - "音量减小"/"音量降低"
    - "静音"/"关闭声音"
- 支持WiFi连接
- 支持IoT设备控制

### 2. 表情模式
- 长按BOOT按钮进入表情模式
- 显示可爱的眨眼动画
- 支持自动眨眼效果（随机单次眨眼或连续快速眨眼两次）
- 支持多种表情动画：开心、伤心、愤怒、惊讶等
- 支持舵机控制头部动作：点头、摇头、摆动等
- 支持手势识别控制舵机动作（使用PAJ7620U2传感器）
- 所有动画均采用专用任务处理，确保流畅自然
- 再次长按BOOT按钮返回对话模式

### 表情动画优化
- 开心表情：优化三角形位置、大小和角度，使表情更加自然
- 悲伤表情：实现为开心表情的精确垂直翻转，确保完美对称
- 点头动作：改进为多次上下点头，更符合自然表达
- 眨眼动画：随机单次眨眼或连续快速眨眼两次，更加生动自然
- 使用LVGL图形库实现高质量的表情动画效果
- 通过精确计算三角形坐标，确保表情一致性
- 优化旋转角度和旋转中心点，使三角形形状更加准确
- 调整动画参数，使表情变化更加流畅自然

## 硬件连接  

### INMP441麦克风连接

INMP441是一款高质量的I2S数字麦克风，连接方式如下：

| INMP441引脚 | ESP32 S3 N16R8引脚 |
|------------|---------------------|
| VDD        | 3.3V                |
| GND        | GND                 |
| SD         | GPIO6              |
| L/R        | GND                 |
| WS         | GPIO4             |
| SCK        | GPIO5             |

### Max98357A音频放大器连接

Max98357A是一款I2S音频放大器，连接方式如下：

| Max98357A引脚 | ESP32 S3 N16R8引脚 |
|-------------|---------------------|
| VIN         | 3.3V          |
| GND         | GND                 |
| DIN         | GPIO7              |
| BCLK        | GPIO15             |
| LRC         | GPIO16              |
| GAIN        | GND           |
| SD          | 3.3V          |

### SSD1306 OLED显示屏连接

| SSD1306引脚 | ESP32 S3 N16R8引脚 |
|------------|---------------------|
| VCC        | 3.3V                |
| GND        | GND                 |
| SCL        | GPIO42              |
| SDA        | GPIO41              |

### PAJ7620U2手势识别传感器模块连接

| PAJ7620U2引脚 | ESP32 S3 N16R8引脚 |
|------------|---------------------|
| VCC        | 3.3V                |
| GND        | GND                 |
| SCL        | GPIO42              |
| SDA        | GPIO41              |
| INT        | 悬空              |

### 舵机连接

| 舵机       | ESP32 S3 N16R8引脚 |
|-----------|---------------------|
| 水平舵机信号线 | GPIO11             |
| 垂直舵机信号线 | GPIO12             |
| VCC        | 5V                  |
| GND        | GND                 |

### 按钮配置

| 按钮       | ESP32 S3 N16R8引脚 | 功能描述 |
|-----------|---------------------|---------|
| BOOT按钮   | GPIO0              | 短按：切换对话状态<br>长按：切换表情模式 |
| 音量增加按钮 | GPIO40             | 短按：音量+10<br>长按：最大音量 |
| 音量减少按钮 | GPIO39             | 短按：音量-10<br>长按：静音 |

## 使用说明

### 对话模式
1. 开机后自动进入对话模式
2. 短按BOOT按钮开始对话
3. 使用音量按钮调节音量
4. 支持WiFi连接和IoT设备控制

### 表情模式
1. 长按BOOT按钮进入表情模式
2. 屏幕将显示两个白色眼睛（黑底白眼）
3. 眼睛会自动每5秒眨眼一次
4. 再次长按BOOT按钮返回对话模式
5. 在表情模式下，音量按钮仍然可以调节音量
6. 短按BOOT按钮仍然可以进入录音模式

## 表情动画系统

### 眨眼动画
- 自动每5秒眨眼一次
- 眨眼动画模拟自然眨眼效果
- 眨眼速度和幅度可调整

### 表情动画
- 开心表情：眼睛下方显示微笑效果
- 伤心表情：眼睛上方显示悲伤效果
- 愤怒表情：眼睛上方显示愤怒效果
- 惊讶表情：眼睛逐渐缩小，模拟惊讶效果
- 疑惑表情：眼睛上下移动，模拟疑惑效果
- 向左看表情：眼睛向左移动
- 向右看表情：眼睛向右移动
- 睡眠表情：眼睛变为水平线
- 唤醒表情：从睡眠状态逐渐恢复正常

### 舵机控制
- 头部居中：将舵机恢复到中心位置
- 头部点头：模拟点头动作
- 头部摇头：模拟摇头动作
- 头部转圈：模拟头部转圈效果
- 头部向左：模拟向左看动作
- 头部向右：模拟向右看动作
- 所有舵机动作均采用平滑过渡，确保自然流畅

### 随机表情和动作
系统会每10秒随机执行以下表情和动作组合，使表情板更加生动有趣：

1. 眨眼（眨眼表情+无动作）- 60%概率
2. 向左看（向左表情+舵机向左）- 15%概率
3. 向右看（向右表情+舵机向右）- 15%概率
4. 高兴（高兴表情+无动作）- 5%概率
5. 转圈（默认眼睛+转圈动作）- 5%概率


### 3. 手势识别控制

小智AI支持通过PAJ7620U2手势识别传感器控制舵机动作，实现更自然的人机交互体验：

- **基本手势控制**：
  - 向左手势：控制舵机向左转动
  - 向右手势：控制舵机向右转动
  - 向上手势：控制舵机向上抬头
  - 向下手势：控制舵机向下低头
  - 顺时针/逆时针手势：控制舵机做转圈动作
  - 向前手势：控制舵机回到中心位置

- **组合手势识别**：
  - 快速上下手势：识别为点头动作，触发HeadNod效果
  - 快速左右手势：识别为摇头动作，触发HeadShake效果

- **技术实现**：
  - 使用I2C接口与PAJ7620U2传感器通信
  - 独立任务处理手势识别，不影响主程序运行
  - 智能防抖设计，避免误触发
  - 连续手势识别算法，支持复杂手势组合

## 最新功能更新 (2025-05-14)

### 手势识别控制功能

- **添加PAJ7620U2手势识别传感器支持**：通过手势直接控制小智AI的头部动作
- **实现智能手势组合识别**：快速上下手势识别为点头，快速左右手势识别为摇头
- **优化眨眼动画**：随机单次眨眼或连续快速眨眼两次，增加表情生动性

## 功能更新历史 (2025-05-12)

### 情感响应系统优化

#### 随机动画控制
- **对话过程中禁用随机动画**：在用户与AI对话期间（包括用户说话和AI回复阶段），系统会自动禁用随机表情动画，确保交互过程不被随机动画打断
- **对话结束后恢复随机动画**：当对话结束3秒后，系统会自动恢复随机表情动画，使表情板在空闲状态下保持生动有趣
- **动画队列清理**：在禁用随机动画时，系统会清空所有已排队的动画消息，确保不会有残留的随机动画在对话过程中执行

#### AI情感响应增强
- **AI回复开始时触发积极情感**：当AI开始回复时，系统会随机触发开心或惊讶的表情，增强交互的生动性
- **AI回复结束时触发随机情感**：当AI回复结束时，系统会根据回复内容触发相应的情感表情，使表情板能够更好地表达AI的情感
- **对话结束时恢复中性情感**：当对话完全结束时，系统会恢复到中性表情状态，为下一次交互做准备

#### 状态监控优化
- **精确的状态转换检测**：优化了设备状态监控逻辑，能够准确检测对话的开始、继续和结束
- **减少对话结束判断延迟**：将对话结束的判断延迟从10秒减少到3秒，使系统能够更快地恢复到空闲状态
- **增强的日志记录**：添加了详细的状态变化和动画控制日志，便于调试和监控系统行为

### 技术实现
- 使用状态监控任务实时检测设备状态变化
- 通过情感响应控制器分析AI回复内容并触发相应的情感表情
- 采用消息队列管理动画请求，确保动画执行的可靠性和顺序性
- 实现了随机动画的启用/禁用控制接口，可根据上下文灵活控制随机动画行为

## 最近更新

### 情感响应系统优化 (2025-05-13)

1. **栈溢出问题修复**：
   - 优化了情感命令处理逻辑，将正则表达式替换为简单的字符串查找，大幅减少栈使用
   - 增加了`ai_response`任务的栈大小从4096字节到8192字节，确保有足够的栈空间
   - 修复了在处理特殊字符时可能导致的栈溢出问题

2. **舵机动作执行优化**：
   - 改进了舵机动作执行逻辑，确保即使屏幕或眼睛对象不存在，也能执行舵机动作
   - 优化了向左看和向右看动作的执行顺序，先执行舵机动作，再执行表情动画

3. **情感词汇识别增强**：
   - 扩充了情感关键词列表，提高情感识别的准确性
   - 添加了更多中英文情感表达词汇，使系统能够识别更多的情感表达方式
   - 优化了情感命令处理逻辑，支持更多自然语言表达

4. **技术实现**：
   - 使用友元函数解决类之间的访问限制问题
   - 优化了任务处理逻辑，避免重复创建任务，减少资源消耗
   - 使用简单高效的字符串处理方法，提高系统性能和稳定性

### 音量控制功能修复 (2025-05-12)

1. **问题修复**：
   - 修复了通过语音命令控制音量无效的问题
   - 修复了物联网功能初始化导致系统崩溃的问题

2. **音量控制增强**：
   - 支持多种音量控制命令格式：
     - "音量设为xx"（如"音量设为50"）
     - "音量调到xx"（如"音量调到80"）
     - "把音量设为xx"
     - "将声音设置为xx"
     - "音量增加"/"音量加大"
     - "音量减小"/"音量降低"
     - "静音"/"关闭声音"
   - 同时支持按键控制和语音控制两种方式

3. **技术实现**：
   - 通过正则表达式识别多种音量控制命令格式
   - 同时使用AudioCodec和物联网接口(Speaker Thing)两种方式设置音量
   - 安全初始化物联网功能，避免系统崩溃
   - 添加异常处理，提高系统稳定性

4. **使用方法**：
   - 直接对小智AI说出音量控制命令，如"音量设为50"
   - 或使用设备上的音量+/音量-按钮手动调节

## 技术实现

### 动画管理系统
- 采用专用任务处理所有动画效果
- 使用消息队列管理动画请求
- 支持多种动画类型和参数
- 安全处理延迟和动画执行

### 舵机控制系统
- 采用PWM控制舵机
- 支持平滑过渡和精确控制
- 舵机角度范围和速度可配置

### 显示系统
- 使用LVGL图形库实现表情显示
- 支持动态调整表情大小和位置
- 黑底白眼设计，确保视觉效果
